<!DOCTYPE HTML><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta><title>Application.Configuration_EnableInMemory</title><link rel="stylesheet" href="../../../../../Style/Master.css" type="text/css"><script src="../../../../../Scripts/jquery-1.9.1.js" type="text/javascript"></script><script src="../../../../../Scripts/sections.js" type="text/javascript"></script></head><body><div id="wrap"><div id="container"><div id="header"><div id="breadcrumbs"><a href="../../../../../index.html">Project</a> &gt; <a href="../../../../../pc-cas_dev/index.html">pc-cas\dev</a> &gt; <a href="../../../../../pc-cas_dev/User_databases/index.html">User databases</a> &gt; <a href="../../../../../pc-cas_dev/User_databases/WideWorldImporters/index.html">WideWorldImporters</a> &gt; Programmability &gt; <a href="../../../../../pc-cas_dev/User_databases/WideWorldImporters/Programmability/Stored_Procedures/Stored_Procedures.html">Stored Procedures</a> &gt; Application.Configuration_EnableInMemory</div><div id="headerText"></div></div><div id="pageTitle"><img src="../../../../../Images/StoredProcedure32.png" alt="Stored Procedures" title="Stored Procedures" class="StoredProcedure32"> [Application].[Configuration_EnableInMemory]</div><div class="panel panel-default panel-collapsible"><div class="panel-heading"><div class="expandCollapse"><img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;"><img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style=""></div><a name="properties">Properties</a></div><div class="panel-body"><table cellspacing="1" border="0" class="dataTable table-hover"><tbody><tr><th>Property</th><th>Value</th></tr><tr><td>ANSI Nulls On</td><td><span class="do-yes">True</span></td></tr><tr><td>Quoted Identifier On</td><td><span class="do-yes">True</span></td></tr></tbody></table></div></div><div class="panel panel-default panel-collapsible"><div class="panel-heading"><div class="expandCollapse"><img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;"><img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style=""></div><a name="sqlscript">SQL Script</a></div><div class="panel-body"><div id="sqlScript"><br><span class="sqlScriptsKeyword">CREATE</span> <span class="sqlScriptsKeyword">PROCEDURE</span> <span class="sqlScriptsNormal">[Application]</span><span class="sqlScriptsOperator">.</span><span class="sqlScriptsNormal">[Configuration_EnableInMemory]</span><br><span class="sqlScriptsKeyword">AS</span><br><span class="sqlScriptsKeyword">BEGIN</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsKeyword">NOCOUNT</span> <span class="sqlScriptsKeyword">ON</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsKeyword">XACT_ABORT</span> <span class="sqlScriptsKeyword">ON</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">IF</span> <span class="sqlScriptsFunction">SERVERPROPERTY</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;IsXTPSupported&#39;</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">BEGIN</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">PRINT</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;Warning: In-memory tables cannot be created on this edition.&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">END</span> <span class="sqlScriptsKeyword">ELSE</span> <span class="sqlScriptsKeyword">BEGIN</span> <span class="sqlScriptsComment">-- if in-memory can be created</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">DECLARE</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">max</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">BEGIN</span> <span class="sqlScriptsNormal">TRY</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">IF</span> <span class="sqlScriptsFunction">CAST</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">SERVERPROPERTY</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;EngineEdition&#39;</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">AS</span> <span class="sqlScriptsKeyword">int</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsNormal">&lt;&gt;</span> <span class="sqlScriptsNormal">5</span> &nbsp;&nbsp;<span class="sqlScriptsComment">-- Not an Azure SQL DB</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">BEGIN</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">DECLARE</span> <span class="sqlScriptsNormal">@SQLDataFolder</span> <span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">max</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">CAST</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">SERVERPROPERTY</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;InstanceDefaultDataPath&#39;</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">AS</span> <span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">max</span><span class="sqlScriptsNormal">));</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">DECLARE</span> <span class="sqlScriptsNormal">@MemoryOptimizedFilegroupFolder</span> <span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">max</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@SQLDataFolder</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;WideWorldImporters_InMemory_Data_1&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">IF</span> <span class="sqlScriptsOperator">NOT</span> <span class="sqlScriptsOperator">EXISTS</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">SELECT</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">FROM</span> <span class="sqlScriptsSystemView">sys.filegroups</span> <span class="sqlScriptsKeyword">WHERE</span> <span class="sqlScriptsKeyword">name</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;WWI_InMemory_Data&#39;</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">BEGIN</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>ALTER DATABASE CURRENT<br>ADD FILEGROUP WWI_InMemory_Data CONTAINS MEMORY_OPTIMIZED_DATA;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>ALTER DATABASE CURRENT<br>ADD FILE (name = N&#39;&#39;WWI_InMemory_Data_1&#39;&#39;, filename = &#39;&#39;&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@MemoryOptimizedFilegroupFolder</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;&#39;&#39;)<br>TO FILEGROUP WWI_InMemory_Data;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">END</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">END</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>ALTER DATABASE CURRENT<br>SET MEMORY_OPTIMIZED_ELEVATE_TO_SNAPSHOT = ON;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">IF</span> <span class="sqlScriptsOperator">NOT</span> <span class="sqlScriptsOperator">EXISTS</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">SELECT</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">FROM</span> <span class="sqlScriptsSystemView">sys.tables</span> <span class="sqlScriptsKeyword">WHERE</span> <span class="sqlScriptsKeyword">name</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;ColdRoomTemperatures&#39;</span> <span class="sqlScriptsOperator">AND</span> <span class="sqlScriptsNormal">is_memory_optimized</span> <span class="sqlScriptsNormal">&lt;&gt;</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">BEGIN</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>ALTER TABLE Warehouse.ColdRoomTemperatures SET (SYSTEM_VERSIONING = OFF);<br>ALTER TABLE Warehouse.ColdRoomTemperatures DROP PERIOD FOR SYSTEM_TIME;<br>ALTER TABLE Warehouse.ColdRoomTemperatures DROP CONSTRAINT PK_Warehouse_ColdRoomTemperatures;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>EXEC dbo.sp_rename @objname = N&#39;&#39;Warehouse.ColdRoomTemperatures&#39;&#39;,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@newname = N&#39;&#39;ColdRoomTemperatures_Backup&#39;&#39;,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@objtype = N&#39;&#39;OBJECT&#39;&#39;;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>CREATE TABLE Warehouse.ColdRoomTemperatures<br>(<br> &nbsp;&nbsp;&nbsp;ColdRoomTemperatureID bigint IDENTITY(1,1) NOT NULL,<br> &nbsp;&nbsp;&nbsp;ColdRoomSensorNumber int NOT NULL,<br> &nbsp;&nbsp;&nbsp;RecordedWhen datetime2(7) NOT NULL,<br> &nbsp;&nbsp;&nbsp;Temperature decimal(10, 2) NOT NULL,<br> &nbsp;&nbsp;&nbsp;ValidFrom datetime2(7) NOT NULL,<br> &nbsp;&nbsp;&nbsp;ValidTo datetime2(7) NOT NULL,<br> &nbsp;&nbsp;&nbsp;INDEX [IX_Warehouse_ColdRoomTemperatures_ColdRoomSensorNumber] NONCLUSTERED (ColdRoomSensorNumber),<br> &nbsp;&nbsp;&nbsp;CONSTRAINT PK_Warehouse_ColdRoomTemperatures PRIMARY KEY NONCLUSTERED (ColdRoomTemperatureID)<br>) WITH (MEMORY_OPTIMIZED = ON ,DURABILITY = SCHEMA_AND_DATA);&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>SET IDENTITY_INSERT Warehouse.ColdRoomTemperatures ON;<br><br>INSERT Warehouse.ColdRoomTemperatures (ColdRoomTemperatureID, ColdRoomSensorNumber, RecordedWhen, Temperature,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidFrom, ValidTo)<br>SELECT ColdRoomTemperatureID, ColdRoomSensorNumber, RecordedWhen, Temperature, ValidFrom, ValidTo<br>FROM Warehouse.ColdRoomTemperatures_Backup;<br><br>SET IDENTITY_INSERT Warehouse.ColdRoomTemperatures OFF;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;DROP TABLE Warehouse.ColdRoomTemperatures_Backup;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>ALTER TABLE Warehouse.ColdRoomTemperatures<br>ADD PERIOD FOR SYSTEM_TIME(ValidFrom, ValidTo);&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>ALTER TABLE Warehouse.ColdRoomTemperatures<br>SET (SYSTEM_VERSIONING = ON (HISTORY_TABLE = Warehouse.ColdRoomTemperatures_Archive, DATA_CONSISTENCY_CHECK = ON));&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">END</span><span class="sqlScriptsNormal">;</span> <span class="sqlScriptsComment">-- of if we need to move ColdRoomTemperatures</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">IF</span> <span class="sqlScriptsOperator">NOT</span> <span class="sqlScriptsOperator">EXISTS</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">SELECT</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">FROM</span> <span class="sqlScriptsSystemView">sys.tables</span> <span class="sqlScriptsKeyword">WHERE</span> <span class="sqlScriptsKeyword">name</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;VehicleTemperatures&#39;</span> <span class="sqlScriptsOperator">AND</span> <span class="sqlScriptsNormal">is_memory_optimized</span> <span class="sqlScriptsNormal">&lt;&gt;</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">BEGIN</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>ALTER TABLE Warehouse.VehicleTemperatures DROP CONSTRAINT PK_Warehouse_VehicleTemperatures;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>EXEC dbo.sp_rename @objname = N&#39;&#39;Warehouse.VehicleTemperatures&#39;&#39;,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@newname = N&#39;&#39;VehicleTemperatures_Backup&#39;&#39;,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@objtype = N&#39;&#39;OBJECT&#39;&#39;;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>CREATE TABLE Warehouse.VehicleTemperatures<br>(<br> &nbsp;&nbsp;&nbsp;VehicleTemperatureID bigint IDENTITY(1,1) NOT NULL,<br> &nbsp;&nbsp;&nbsp;VehicleRegistration nvarchar(20) COLLATE Latin1_General_CI_AS NOT NULL,<br> &nbsp;&nbsp;&nbsp;ChillerSensorNumber int NOT NULL,<br> &nbsp;&nbsp;&nbsp;RecordedWhen datetime2(7) NOT NULL,<br> &nbsp;&nbsp;&nbsp;Temperature decimal(10, 2) NOT NULL,<br> &nbsp;&nbsp;&nbsp;FullSensorData nvarchar(1000) COLLATE Latin1_General_CI_AS NULL,<br> &nbsp;&nbsp;&nbsp;IsCompressed bit NOT NULL,<br> &nbsp;&nbsp;&nbsp;CompressedSensorData varbinary(max) NULL,<br> &nbsp;&nbsp;&nbsp;CONSTRAINT PK_Warehouse_VehicleTemperatures PRIMARY KEY NONCLUSTERED (VehicleTemperatureID)<br>) WITH (MEMORY_OPTIMIZED = ON , DURABILITY = SCHEMA_AND_DATA);&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>SET IDENTITY_INSERT Warehouse.VehicleTemperatures ON;<br><br>INSERT Warehouse.VehicleTemperatures<br> &nbsp;&nbsp;&nbsp;(VehicleTemperatureID, VehicleRegistration, ChillerSensorNumber, RecordedWhen, Temperature, FullSensorData, IsCompressed, CompressedSensorData)<br>SELECT VehicleTemperatureID, VehicleRegistration, ChillerSensorNumber, RecordedWhen, Temperature, FullSensorData, IsCompressed, CompressedSensorData<br>FROM Warehouse.VehicleTemperatures_Backup;<br><br>SET IDENTITY_INSERT Warehouse.VehicleTemperatures OFF;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;DROP TABLE Warehouse.VehicleTemperatures_Backup;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">END</span><span class="sqlScriptsNormal">;</span> <span class="sqlScriptsComment">-- of if we need to move VehicleTemperatures</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">-- Drop the procedures that are used by the table types</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;DROP PROCEDURE IF EXISTS Website.InvoiceCustomerOrders;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;DROP PROCEDURE IF EXISTS Website.InsertCustomerOrders;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;DROP PROCEDURE IF EXISTS Website.RecordColdRoomTemperatures;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">-- Drop the table types</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;DROP TYPE IF EXISTS Website.OrderIDList;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;DROP TYPE IF EXISTS Website.OrderLineList;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;DROP TYPE IF EXISTS Website.OrderList;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;DROP TYPE IF EXISTS Website.SensorDataList;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">-- Create the new table types</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>CREATE TYPE Website.OrderIDList AS TABLE<br>(<br> &nbsp;&nbsp;&nbsp;OrderID int PRIMARY KEY NONCLUSTERED<br>)<br>WITH (MEMORY_OPTIMIZED = ON);&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>CREATE TYPE Website.OrderList AS TABLE<br>(<br> &nbsp;&nbsp;&nbsp;OrderReference int PRIMARY KEY NONCLUSTERED,<br> &nbsp;&nbsp;&nbsp;CustomerID int,<br> &nbsp;&nbsp;&nbsp;ContactPersonID int,<br> &nbsp;&nbsp;&nbsp;ExpectedDeliveryDate date,<br> &nbsp;&nbsp;&nbsp;CustomerPurchaseOrderNumber nvarchar(20),<br> &nbsp;&nbsp;&nbsp;IsUndersupplyBackordered bit,<br> &nbsp;&nbsp;&nbsp;Comments nvarchar(max),<br> &nbsp;&nbsp;&nbsp;DeliveryInstructions nvarchar(max)<br>)<br>WITH (MEMORY_OPTIMIZED = ON);&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>CREATE TYPE Website.OrderLineList AS TABLE<br>(<br> &nbsp;&nbsp;&nbsp;OrderReference int,<br> &nbsp;&nbsp;&nbsp;StockItemID int,<br> &nbsp;&nbsp;&nbsp;[Description] nvarchar(100),<br> &nbsp;&nbsp;&nbsp;Quantity int,<br> &nbsp;&nbsp;&nbsp;INDEX IX_Website_OrderLineList NONCLUSTERED (OrderReference)<br>)<br>WITH (MEMORY_OPTIMIZED = ON);&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>CREATE TYPE Website.SensorDataList AS TABLE<br>(<br> &nbsp;&nbsp;&nbsp;SensorDataListID int IDENTITY(1,1) PRIMARY KEY NONCLUSTERED,<br> &nbsp;&nbsp;&nbsp;ColdRoomSensorNumber int,<br> &nbsp;&nbsp;&nbsp;RecordedWhen datetime2(7),<br> &nbsp;&nbsp;&nbsp;Temperature decimal(18,2)<br>)<br>WITH (MEMORY_OPTIMIZED = ON);&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>CREATE PROCEDURE Website.InvoiceCustomerOrders<br>@OrdersToInvoice Website.OrderIDList READONLY,<br>@PackedByPersonID int,<br>@InvoicedByPersonID int<br>WITH EXECUTE AS OWNER<br>AS<br>BEGIN<br> &nbsp;&nbsp;&nbsp;SET NOCOUNT ON;<br> &nbsp;&nbsp;&nbsp;SET XACT_ABORT ON;<br><br> &nbsp;&nbsp;&nbsp;DECLARE @InvoicesToGenerate TABLE<br> &nbsp;&nbsp;&nbsp;(<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderID int PRIMARY KEY,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InvoiceID int NOT NULL,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TotalDryItems int NOT NULL,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TotalChillerItems int NOT NULL<br> &nbsp;&nbsp;&nbsp;);<br><br> &nbsp;&nbsp;&nbsp;BEGIN TRY;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Check that all orders exist, have been fully picked, and not already invoiced. Also allocate new invoice numbers.<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT @InvoicesToGenerate (OrderID, InvoiceID, TotalDryItems, TotalChillerItems)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT oti.OrderID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NEXT VALUE FOR Sequences.InvoiceID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COALESCE((SELECT SUM(CASE WHEN si.IsChillerStock &lt;&gt; 0 THEN 0 ELSE 1 END)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM Sales.OrderLines AS ol<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Warehouse.StockItems AS si<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON ol.StockItemID = si.StockItemID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE ol.OrderID = oti.OrderID), 0),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COALESCE((SELECT SUM(CASE WHEN si.IsChillerStock &lt;&gt; 0 THEN 1 ELSE 0 END)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM Sales.OrderLines AS ol<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Warehouse.StockItems AS si<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON ol.StockItemID = si.StockItemID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE ol.OrderID = oti.OrderID), 0)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM @OrdersToInvoice AS oti<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Sales.Orders AS o<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON oti.OrderID = o.OrderID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE NOT EXISTS (SELECT 1 FROM Sales.Invoices AS i<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE i.OrderID = oti.OrderID)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND o.PickingCompletedWhen IS NOT NULL;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF EXISTS (SELECT 1 FROM @OrdersToInvoice AS oti WHERE NOT EXISTS (SELECT 1 FROM @InvoicesToGenerate AS itg WHERE itg.OrderID = oti.OrderID))<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRINT N&#39;&#39;At least one order ID either does not exist, is not picked, or is already invoiced&#39;&#39;;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;THROW 51000, N&#39;&#39;At least one orderID either does not exist, is not picked, or is already invoiced&#39;&#39;, 1;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN TRAN;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT Sales.Invoices<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(InvoiceID, CustomerID, BillToCustomerID, OrderID, DeliveryMethodID, ContactPersonID, AccountsPersonID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SalespersonPersonID, PackedByPersonID, InvoiceDate, CustomerPurchaseOrderNumber,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IsCreditNote, CreditNoteReason, Comments, DeliveryInstructions, InternalComments,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TotalDryItems, TotalChillerItems, &nbsp;DeliveryRun, RunPosition,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReturnedDeliveryData,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LastEditedBy, LastEditedWhen)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT itg.InvoiceID, c.CustomerID, c.BillToCustomerID, itg.OrderID, c.DeliveryMethodID, o.ContactPersonID, btc.PrimaryContactPersonID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.SalespersonPersonID, @PackedByPersonID, SYSDATETIME(), o.CustomerPurchaseOrderNumber,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, NULL, NULL, c.DeliveryAddressLine1 + N&#39;&#39;, &#39;&#39; + c.DeliveryAddressLine2, NULL,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itg.TotalDryItems, itg.TotalChillerItems, c.DeliveryRun, c.RunPosition,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JSON_MODIFY(N&#39;&#39;{&quot;Events&quot;: []}&#39;&#39;, N&#39;&#39;append $.Events&#39;&#39;,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JSON_MODIFY(JSON_MODIFY(JSON_MODIFY(N&#39;&#39;{ }&#39;&#39;, N&#39;&#39;$.Event&#39;&#39;, N&#39;&#39;Ready for collection&#39;&#39;),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N&#39;&#39;$.EventTime&#39;&#39;, CONVERT(nvarchar(20), SYSDATETIME(), 126)),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N&#39;&#39;$.ConNote&#39;&#39;, N&#39;&#39;EAN-125-&#39;&#39; + CAST(itg.InvoiceID + 1050 AS nvarchar(20)))),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@InvoicedByPersonID, SYSDATETIME()<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM @InvoicesToGenerate AS itg<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Sales.Orders AS o<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON itg.OrderID = o.OrderID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Sales.Customers AS c<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON o.CustomerID = c.CustomerID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Sales.Customers AS btc<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON btc.CustomerID = c.BillToCustomerID;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT Sales.InvoiceLines<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(InvoiceID, StockItemID, [Description], PackageTypeID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quantity, UnitPrice, TaxRate, TaxAmount, LineProfit, ExtendedPrice,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LastEditedBy, LastEditedWhen)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT itg.InvoiceID, ol.StockItemID, ol.[Description], ol.PackageTypeID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ol.PickedQuantity, ol.UnitPrice, ol.TaxRate,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROUND(ol.PickedQuantity * ol.UnitPrice * ol.TaxRate / 100.0, 2),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROUND(ol.PickedQuantity * (ol.UnitPrice - sih.LastCostPrice), 2),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROUND(ol.PickedQuantity * ol.UnitPrice, 2)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ ROUND(ol.PickedQuantity * ol.UnitPrice * ol.TaxRate / 100.0, 2),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@InvoicedByPersonID, SYSDATETIME()<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM @InvoicesToGenerate AS itg<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Sales.OrderLines AS ol<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON itg.OrderID = ol.OrderID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Warehouse.StockItems AS si<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON ol.StockItemID = si.StockItemID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Warehouse.StockItemHoldings AS sih<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON si.StockItemID = sih.StockItemID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ORDER BY ol.OrderID, ol.OrderLineID;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT Warehouse.StockItemTransactions<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(StockItemID, TransactionTypeID, CustomerID, InvoiceID, SupplierID, PurchaseOrderID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TransactionOccurredWhen, Quantity, LastEditedBy, LastEditedWhen)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT il.StockItemID, (SELECT TransactionTypeID FROM [Application].TransactionTypes WHERE TransactionTypeName = N&#39;&#39;Stock Issue&#39;&#39;),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i.CustomerID, i.InvoiceID, NULL, NULL,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SYSDATETIME(), 0 - il.Quantity, @InvoicedByPersonID, SYSDATETIME()<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM @InvoicesToGenerate AS itg<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Sales.InvoiceLines AS il<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON itg.InvoiceID = il.InvoiceID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Sales.Invoices AS i<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON il.InvoiceID = i.InvoiceID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ORDER BY il.InvoiceID, il.InvoiceLineID;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH StockItemTotals<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT il.StockItemID, SUM(il.Quantity) AS TotalQuantity<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM Sales.InvoiceLines aS il<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE il.InvoiceID IN (SELECT InvoiceID FROM @InvoicesToGenerate)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GROUP BY il.StockItemID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UPDATE sih<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET sih.QuantityOnHand -= sit.TotalQuantity,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sih.LastEditedBy = @InvoicedByPersonID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sih.LastEditedWhen = SYSDATETIME()<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM Warehouse.StockItemHoldings AS sih<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN StockItemTotals AS sit<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON sih.StockItemID = sit.StockItemID;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT Sales.CustomerTransactions<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(CustomerID, TransactionTypeID, InvoiceID, PaymentMethodID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TransactionDate, AmountExcludingTax, TaxAmount, TransactionAmount,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutstandingBalance, FinalizationDate, LastEditedBy, LastEditedWhen)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT i.BillToCustomerID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(SELECT TransactionTypeID FROM [Application].TransactionTypes WHERE TransactionTypeName = N&#39;&#39;Customer Invoice&#39;&#39;),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;itg.InvoiceID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SYSDATETIME(),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(SELECT SUM(il.ExtendedPrice - il.TaxAmount) FROM Sales.InvoiceLines AS il WHERE il.InvoiceID = itg.InvoiceID),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(SELECT SUM(il.TaxAmount) FROM Sales.InvoiceLines AS il WHERE il.InvoiceID = itg.InvoiceID),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(SELECT SUM(il.ExtendedPrice) FROM Sales.InvoiceLines AS il WHERE il.InvoiceID = itg.InvoiceID),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(SELECT SUM(il.ExtendedPrice) FROM Sales.InvoiceLines AS il WHERE il.InvoiceID = itg.InvoiceID),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@InvoicedByPersonID,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SYSDATETIME()<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM @InvoicesToGenerate AS itg<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Sales.Invoices AS i<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON itg.InvoiceID = i.InvoiceID;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COMMIT;<br><br> &nbsp;&nbsp;&nbsp;END TRY<br> &nbsp;&nbsp;&nbsp;BEGIN CATCH<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF XACT_STATE() &lt;&gt; 0 ROLLBACK;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRINT N&#39;&#39;Unable to invoice these orders&#39;&#39;;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;THROW;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN -1;<br> &nbsp;&nbsp;&nbsp;END CATCH;<br><br> &nbsp;&nbsp;&nbsp;RETURN 0;<br>END;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>CREATE PROCEDURE Website.RecordColdRoomTemperatures<br>@SensorReadings Website.SensorDataList READONLY<br>WITH NATIVE_COMPILATION, SCHEMABINDING, EXECUTE AS OWNER<br>AS<br>BEGIN ATOMIC WITH<br>(<br> &nbsp;&nbsp;&nbsp;TRANSACTION ISOLATION LEVEL = SNAPSHOT,<br> &nbsp;&nbsp;&nbsp;LANGUAGE = N&#39;&#39;English&#39;&#39;<br>)<br> &nbsp;&nbsp;&nbsp;BEGIN TRY<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DECLARE @NumberOfReadings int = (SELECT MAX(SensorDataListID) FROM @SensorReadings);<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DECLARE @Counter int = (SELECT MIN(SensorDataListID) FROM @SensorReadings);<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DECLARE @ColdRoomSensorNumber int;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DECLARE @RecordedWhen datetime2(7);<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DECLARE @Temperature decimal(18,2);<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- note that we cannot use a merge here because multiple readings might exist for each sensor<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHILE @Counter &lt;= @NumberOfReadings<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT @ColdRoomSensorNumber = ColdRoomSensorNumber,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@RecordedWhen = RecordedWhen,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Temperature = Temperature<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM @SensorReadings<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE SensorDataListID = @Counter;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UPDATE Warehouse.ColdRoomTemperatures<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET RecordedWhen = @RecordedWhen,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Temperature = @Temperature<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE ColdRoomSensorNumber = @ColdRoomSensorNumber;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF @@ROWCOUNT = 0<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT Warehouse.ColdRoomTemperatures<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ColdRoomSensorNumber, RecordedWhen, Temperature)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VALUES (@ColdRoomSensorNumber, @RecordedWhen, @Temperature);<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SET @Counter += 1;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;END;<br><br> &nbsp;&nbsp;&nbsp;END TRY<br> &nbsp;&nbsp;&nbsp;BEGIN CATCH<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;THROW 51000, N&#39;&#39;Unable to apply the sensor data&#39;&#39;, 2;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN 1;<br> &nbsp;&nbsp;&nbsp;END CATCH;<br>END;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">SET</span> <span class="sqlScriptsNormal">@SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br>CREATE PROCEDURE Website.InsertCustomerOrders<br>@Orders Website.OrderList READONLY,<br>@OrderLines Website.OrderLineList READONLY,<br>@OrdersCreatedByPersonID int,<br>@SalespersonPersonID int<br>WITH EXECUTE AS OWNER<br>AS<br>BEGIN<br> &nbsp;&nbsp;&nbsp;SET NOCOUNT ON;<br> &nbsp;&nbsp;&nbsp;SET XACT_ABORT ON;<br><br> &nbsp;&nbsp;&nbsp;DECLARE @OrdersToGenerate AS TABLE<br> &nbsp;&nbsp;&nbsp;(<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderReference int PRIMARY KEY, &nbsp;&nbsp;-- reference from the application<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderID int<br> &nbsp;&nbsp;&nbsp;);<br><br> &nbsp;&nbsp;&nbsp;-- allocate the new order numbers<br><br> &nbsp;&nbsp;&nbsp;INSERT @OrdersToGenerate (OrderReference, OrderID)<br> &nbsp;&nbsp;&nbsp;SELECT OrderReference, NEXT VALUE FOR Sequences.OrderID<br> &nbsp;&nbsp;&nbsp;FROM @Orders;<br><br> &nbsp;&nbsp;&nbsp;BEGIN TRY<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BEGIN TRAN;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT Sales.Orders<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(OrderID, CustomerID, SalespersonPersonID, PickedByPersonID, ContactPersonID, BackorderOrderID, OrderDate,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExpectedDeliveryDate, CustomerPurchaseOrderNumber, IsUndersupplyBackordered, Comments, DeliveryInstructions, InternalComments,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PickingCompletedWhen, LastEditedBy, LastEditedWhen)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT otg.OrderID, o.CustomerID, @SalespersonPersonID, NULL, o.ContactPersonID, NULL, SYSDATETIME(),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.ExpectedDeliveryDate, o.CustomerPurchaseOrderNumber, o.IsUndersupplyBackordered, o.Comments, o.DeliveryInstructions, NULL,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL, @OrdersCreatedByPersonID, SYSDATETIME()<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM @OrdersToGenerate AS otg<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN @Orders AS o<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON otg.OrderReference = o.OrderReference;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INSERT Sales.OrderLines<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(OrderID, StockItemID, [Description], PackageTypeID, Quantity, UnitPrice,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TaxRate, PickedQuantity, PickingCompletedWhen, LastEditedBy, LastEditedWhen)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT otg.OrderID, ol.StockItemID, ol.[Description], si.UnitPackageID, ol.Quantity,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Website.CalculateCustomerPrice(o.CustomerID, ol.StockItemID, SYSDATETIME()),<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;si.TaxRate, 0, NULL, @OrdersCreatedByPersonID, SYSDATETIME()<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM @OrdersToGenerate AS otg<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN @OrderLines AS ol<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON otg.OrderReference = ol.OrderReference<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN @Orders AS o<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON ol.OrderReference = o.OrderReference<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Warehouse.StockItems AS si<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON ol.StockItemID = si.StockItemID;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COMMIT;<br><br> &nbsp;&nbsp;&nbsp;END TRY<br> &nbsp;&nbsp;&nbsp;BEGIN CATCH<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF XACT_STATE() &lt;&gt; 0 ROLLBACK;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PRINT N&#39;&#39;Unable to create the customer orders.&#39;&#39;;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;THROW;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN -1;<br> &nbsp;&nbsp;&nbsp;END CATCH;<br><br> &nbsp;&nbsp;&nbsp;RETURN 0;<br>END;&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">EXECUTE</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@SQL</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">END</span> <span class="sqlScriptsNormal">TRY</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">BEGIN</span> <span class="sqlScriptsNormal">CATCH</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">PRINT</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;Unable to apply in-memory tables&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">THROW</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">END</span> <span class="sqlScriptsNormal">CATCH</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">END</span><span class="sqlScriptsNormal">;</span> <span class="sqlScriptsComment">-- of in-memory is allowed</span><br><span class="sqlScriptsKeyword">END</span><span class="sqlScriptsNormal">;</span><br><span class="sqlScriptsNormal">GO</span><br></div></div></div><div class="panel panel-default panel-collapsible"><div class="panel-heading"><div class="expandCollapse"><img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;"><img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style=""></div><a name="uses">Uses</a></div><div class="panel-body"><ul class="DependencyList"><li><a href="../../../../../pc-cas_dev/User_databases/WideWorldImporters/Security/Schemas/Application.html">Application</a></li> </ul></div></div><div class="panel panel-default panel-collapsible"><div class="panel-heading"><div class="expandCollapse"><img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;"><img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style=""></div><a name="usedby">Used By</a></div><div class="panel-body"><ul class="DependencyList"><li><a href="../../../../../pc-cas_dev/User_databases/WideWorldImporters/Programmability/Stored_Procedures/Configuration_ConfigureForEnterpriseEdition.html">[Application].[Configuration_ConfigureForEnterpriseEdition]</a></li> </ul></div></div></div></div><div id="footer"><div class="row"><div id="customtext" class="col-sm-4"><div id="projectauthor">Author: &nbsp;richa</div></div><div id="copyright" class="col-sm-4">Copyright 2020 - All Rights Reserved</div><div id="date" class="col-sm-4">Created: 26 June 2020 10:48:44</div></div></div></body></html>